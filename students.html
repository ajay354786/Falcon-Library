<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Management - Falcon Library</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="navbar-brand">FALCON LIBRARY</div>
            <ul class="navbar-menu">
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="students.html" class="active">Students</a></li>
                <li><a href="seats.html">Seats</a></li>
                <li><a href="shifts.html">Shifts</a></li>
                <li><a href="reports.html">Reports</a></li>
                <li><a href="settings.html">Settings</a></li>
                <li><a href="#" onclick="logout()">Logout</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h1>Student Management</h1>
                <button class="btn btn-primary" onclick="openAddStudentModal()">+ Add Student</button>
            </div>

            <!-- Filter & Search -->
            <div class="filter-section">
                <input type="text" id="searchInput" placeholder="Search by name or mobile..." class="search-box">
                <select id="statusFilter" class="filter-select">
                    <option value="">All Status</option>
                    <option value="Active">Active</option>
                    <option value="Expired">Expired</option>
                </select>
            </div>

            <!-- Students Table -->
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 40px;"></th>
                            <th>Photo</th>
                            <th>Name</th>
                            <th>Mobile</th>
                            <th>Joining Date</th>
                            <th>Seat</th>
                            <th>Shift</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="studentTable">
                        <tr>
                            <td colspan="9" class="empty-state">No students found. Add a new student to get started.</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Payment Ledger Modal -->
            <div id="paymentLedgerModal" class="modal">
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h2>Payment Ledger - <span id="ledgerStudentName"></span></h2>
                        <span class="close" onclick="closePaymentLedger()">&times;</span>
                    </div>
                    <div class="modal-body" style="padding: 20px;">
                        <div style="margin-bottom: 20px;">
                            <button class="btn btn-primary" onclick="openAddPaymentModal()">+ Add Payment</button>
                        </div>
                        <table class="data-table" style="margin: 0;">
                            <thead>
                                <tr>
                                    <th>Notes</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Due Date</th>
                                    <th>Payment Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="paymentLedgerTable">
                                <tr>
                                    <td colspan="6" class="empty-state">No payment records found</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Add/Edit Payment Modal -->
            <div id="paymentModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="paymentModalTitle">Add Payment</h2>
                        <span class="close" onclick="closePaymentModal()">&times;</span>
                    </div>
                    <form id="paymentForm" onsubmit="savePayment(event)">
                        <input type="hidden" id="paymentId">
                        <input type="hidden" id="paymentStudentId">
                        
                        <div class="form-group">
                            <label>Amount *</label>
                            <input type="number" id="paymentAmount" required min="0" step="0.01">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Status *</label>
                                <select id="paymentStatus" required>
                                    <option value="Unpaid">Unpaid</option>
                                    <option value="Paid">Paid</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Due Date *</label>
                                <input type="date" id="paymentDueDate" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Payment Date</label>
                                <input type="date" id="paymentPaymentDate">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Notes</label>
                            <textarea id="paymentNotes" rows="3" placeholder="Add any notes about this payment..."></textarea>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Save Payment</button>
                            <button type="button" class="btn btn-secondary" onclick="closePaymentModal()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Student Modal -->
    <div id="studentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add Student</h2>
                <span class="close" onclick="closeStudentModal()">&times;</span>
            </div>
            <form id="studentForm" onsubmit="saveStudent(event)">
                <input type="hidden" id="studentId">
                
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" id="studentName" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Mobile Number *</label>
                        <input type="tel" id="studentMobile" required pattern="[0-9]{10}">
                    </div>
                    <div class="form-group">
                        <label>Joining Date *</label>
                        <input type="date" id="studentJoiningDate" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Seat Number</label>
                        <select id="studentSeat">
                            <option value="">Select a seat</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Shift</label>
                        <select id="studentShift">
                            <option value="">Select a shift</option>
                            <option value="Morning">Morning</option>
                            <option value="Evening">Evening</option>
                            <option value="Full Day">Full Day</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Status</label>
                    <select id="studentStatus">
                        <option value="Active">Active</option>
                        <option value="Expired">Expired</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Photo (Optional)</label>
                    <input type="file" id="studentPhoto" accept="image/*">
                    <small>Recommended size: 200x200px</small>
                </div>

                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-secondary" onclick="closeStudentModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadStudents();
            loadSeats();
            setupFilters();
        });

        function loadStudents() {
            const students = JSON.parse(localStorage.getItem('students')) || [];
            const tbody = document.getElementById('studentTable');
            tbody.innerHTML = '';

            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No students found. Add a new student to get started.</td></tr>';
                return;
            }

            students.forEach(student => {
                const row = document.createElement('tr');
                const photo = student.photo ? `<img src="${student.photo}" alt="${student.name}" class="student-photo">` : '<div class="student-photo-placeholder">ðŸ“·</div>';
                
                row.innerHTML = `
                    <td><button class="btn-expand" onclick="openPaymentLedger(${student.id})" title="View Payments">ðŸ“‹</button></td>
                    <td>${photo}</td>
                    <td>${student.name}</td>
                    <td>${student.mobile}</td>
                    <td>${new Date(student.joiningDate).toLocaleDateString('en-IN')}</td>
                    <td>${student.seatNumber || '-'}</td>
                    <td>${student.shift || '-'}</td>
                    <td><span class="status-badge ${student.status.toLowerCase()}">${student.status}</span></td>
                    <td>
                        <button class="btn-small" onclick="editStudent(${student.id})">Edit</button>
                        <button class="btn-small btn-danger" onclick="deleteStudent(${student.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadSeats() {
            const students = JSON.parse(localStorage.getItem('students')) || [];
            const seatSelect = document.getElementById('studentSeat');
            const settings = JSON.parse(localStorage.getItem('settings')) || { totalSeats: 0 };
            
            seatSelect.innerHTML = '<option value="">Select a seat</option>';
            
            for (let i = 1; i <= (settings.totalSeats || 0); i++) {
                const isOccupied = students.some(s => s.seatNumber == i && s.status === 'Active' && (!document.getElementById('studentId').value || s.id != document.getElementById('studentId').value));
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Seat ${i}${isOccupied ? ' (Occupied)' : ' (Vacant)'}`;
                option.disabled = isOccupied;
                seatSelect.appendChild(option);
            }
        }

        function setupFilters() {
            document.getElementById('searchInput').addEventListener('input', filterStudents);
            document.getElementById('statusFilter').addEventListener('change', filterStudents);
        }

        function filterStudents() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const students = JSON.parse(localStorage.getItem('students')) || [];
            
            const filtered = students.filter(s => {
                const matchesSearch = s.name.toLowerCase().includes(searchTerm) || s.mobile.includes(searchTerm);
                const matchesStatus = !statusFilter || s.status === statusFilter;
                return matchesSearch && matchesStatus;
            });

            displayFilteredStudents(filtered);
        }

        function displayFilteredStudents(filtered) {
            const tbody = document.getElementById('studentTable');
            tbody.innerHTML = '';

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No students found.</td></tr>';
                return;
            }

            filtered.forEach(student => {
                const row = document.createElement('tr');
                const photo = student.photo ? `<img src="${student.photo}" alt="${student.name}" class="student-photo">` : '<div class="student-photo-placeholder">ðŸ“·</div>';
                
                row.innerHTML = `
                    <td>${photo}</td>
                    <td>${student.name}</td>
                    <td>${student.mobile}</td>
                    <td>${new Date(student.joiningDate).toLocaleDateString('en-IN')}</td>
                    <td>${student.seatNumber || '-'}</td>
                    <td>${student.shift || '-'}</td>
                    <td><span class="status-badge ${student.status.toLowerCase()}">${student.status}</span></td>
                    <td>
                        <button class="btn-small" onclick="editStudent(${student.id})">Edit</button>
                        <button class="btn-small btn-danger" onclick="deleteStudent(${student.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function openAddStudentModal() {
            document.getElementById('studentId').value = '';
            document.getElementById('studentForm').reset();
            document.getElementById('modalTitle').textContent = 'Add Student';
            document.getElementById('studentModal').style.display = 'block';
            loadSeats();
        }

        function editStudent(id) {
            const students = JSON.parse(localStorage.getItem('students')) || [];
            const student = students.find(s => s.id === id);
            
            if (student) {
                document.getElementById('studentId').value = student.id;
                document.getElementById('studentName').value = student.name;
                document.getElementById('studentMobile').value = student.mobile;
                document.getElementById('studentJoiningDate').value = student.joiningDate;
                document.getElementById('studentSeat').value = student.seatNumber || '';
                document.getElementById('studentShift').value = student.shift || '';
                document.getElementById('studentStatus').value = student.status;
                document.getElementById('modalTitle').textContent = 'Edit Student';
                document.getElementById('studentModal').style.display = 'block';
                loadSeats();
            }
        }

        function closeStudentModal() {
            document.getElementById('studentModal').style.display = 'none';
        }

        function saveStudent(event) {
            event.preventDefault();
            
            const students = JSON.parse(localStorage.getItem('students')) || [];
            const id = document.getElementById('studentId').value;
            
            const studentData = {
                id: id ? parseInt(id) : Date.now(),
                name: document.getElementById('studentName').value,
                mobile: document.getElementById('studentMobile').value,
                joiningDate: document.getElementById('studentJoiningDate').value,
                seatNumber: document.getElementById('studentSeat').value || null,
                shift: document.getElementById('studentShift').value || null,
                status: document.getElementById('studentStatus').value
            };

            // Handle photo
            const fileInput = document.getElementById('studentPhoto');
            if (fileInput.files && fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    studentData.photo = e.target.result;
                    saveStudentData(students, studentData);
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                const existingStudent = students.find(s => s.id === studentData.id);
                if (existingStudent && existingStudent.photo) {
                    studentData.photo = existingStudent.photo;
                }
                saveStudentData(students, studentData);
            }
        }

        function saveStudentData(students, studentData) {
            const existingIndex = students.findIndex(s => s.id === studentData.id);
            
            if (existingIndex > -1) {
                students[existingIndex] = studentData;
            } else {
                students.push(studentData);
            }
            
            localStorage.setItem('students', JSON.stringify(students));
            closeStudentModal();
            loadStudents();
            alert('Student saved successfully!');
        }

        function deleteStudent(id) {
            if (confirm('Are you sure you want to delete this student?')) {
                const students = JSON.parse(localStorage.getItem('students')) || [];
                const filtered = students.filter(s => s.id !== id);
                localStorage.setItem('students', JSON.stringify(filtered));
                loadStudents();
                alert('Student deleted successfully!');
            }
        }

        // ===== PAYMENT LEDGER FUNCTIONS =====
        let currentStudentId = null;

        function openPaymentLedger(studentId) {
            currentStudentId = studentId;
            const students = JSON.parse(localStorage.getItem('students')) || [];
            const student = students.find(s => s.id === studentId);
            
            if (!student) {
                alert('Student not found!');
                return;
            }

            document.getElementById('ledgerStudentName').textContent = `${student.name} (${student.mobile})`;
            loadPaymentLedger(studentId);
            document.getElementById('paymentLedgerModal').style.display = 'block';
        }

        function closePaymentLedger() {
            document.getElementById('paymentLedgerModal').style.display = 'none';
            currentStudentId = null;
        }

        function loadPaymentLedger(studentId) {
            const payments = JSON.parse(localStorage.getItem('payments')) || [];
            const studentPayments = payments.filter(p => p.studentId === studentId);
            const ledgerTable = document.getElementById('paymentLedgerTable');
            
            ledgerTable.innerHTML = '';

            if (studentPayments.length === 0) {
                ledgerTable.innerHTML = '<tr><td colspan="6" class="empty-state">No payment records found</td></tr>';
            } else {
                studentPayments.sort((a, b) => new Date(b.dueDate) - new Date(a.dueDate));
                
                studentPayments.forEach(payment => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${payment.notes || '-'}</td>
                        <td>â‚¹${parseFloat(payment.amount).toLocaleString('en-IN')}</td>
                        <td><span class="status-badge ${payment.status.toLowerCase()}">${payment.status}</span></td>
                        <td>${payment.dueDate ? new Date(payment.dueDate).toLocaleDateString('en-IN') : '-'}</td>
                        <td>${payment.paymentDate ? new Date(payment.paymentDate).toLocaleDateString('en-IN') : '-'}</td>
                        <td>
                            <button class="btn-small" onclick="editPayment(${payment.id})">Edit</button>
                            <button class="btn-small btn-danger" onclick="deletePayment(${payment.id})">Delete</button>
                        </td>
                    `;
                    ledgerTable.appendChild(row);
                });
            }
        }

        function openAddPaymentModal() {
            if (!currentStudentId) {
                alert('Please select a student first!');
                return;
            }
            
            document.getElementById('paymentId').value = '';
            document.getElementById('paymentStudentId').value = currentStudentId;
            document.getElementById('paymentForm').reset();
            
            // Set due date to 1 month from today
            const today = new Date();
            const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, today.getDate());
            const dueDate = nextMonth.toISOString().split('T')[0];
            document.getElementById('paymentDueDate').value = dueDate;
            
            document.getElementById('paymentModalTitle').textContent = 'Add Payment';
            document.getElementById('paymentModal').style.display = 'block';
        }

        function editPayment(paymentId) {
            const payments = JSON.parse(localStorage.getItem('payments')) || [];
            const payment = payments.find(p => p.id === paymentId);
            
            if (!payment) {
                alert('Payment not found!');
                return;
            }

            document.getElementById('paymentId').value = payment.id;
            document.getElementById('paymentStudentId').value = payment.studentId;
            document.getElementById('paymentAmount').value = payment.amount;
            document.getElementById('paymentStatus').value = payment.status;
            document.getElementById('paymentDueDate').value = payment.dueDate;
            document.getElementById('paymentPaymentDate').value = payment.paymentDate || '';
            document.getElementById('paymentNotes').value = payment.notes || '';
            document.getElementById('paymentModalTitle').textContent = 'Edit Payment';
            document.getElementById('paymentModal').style.display = 'block';
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').style.display = 'none';
        }

        function savePayment(event) {
            event.preventDefault();
            
            const payments = JSON.parse(localStorage.getItem('payments')) || [];
            const paymentId = document.getElementById('paymentId').value;
            const studentId = parseInt(document.getElementById('paymentStudentId').value);
            
            const paymentData = {
                id: paymentId ? parseInt(paymentId) : Date.now(),
                studentId: studentId,
                amount: parseFloat(document.getElementById('paymentAmount').value),
                status: document.getElementById('paymentStatus').value,
                dueDate: document.getElementById('paymentDueDate').value,
                paymentDate: document.getElementById('paymentPaymentDate').value || null,
                notes: document.getElementById('paymentNotes').value || ''
            };

            if (paymentId) {
                // Edit existing payment
                const index = payments.findIndex(p => p.id === parseInt(paymentId));
                if (index > -1) {
                    payments[index] = paymentData;
                }
            } else {
                // Add new payment
                payments.push(paymentData);
            }

            localStorage.setItem('payments', JSON.stringify(payments));
            closePaymentModal();
            loadPaymentLedger(studentId);
            alert('Payment saved successfully!');
        }

        function deletePayment(paymentId) {
            if (confirm('Are you sure you want to delete this payment?')) {
                const payments = JSON.parse(localStorage.getItem('payments')) || [];
                const filteredPayments = payments.filter(p => p.id !== paymentId);
                localStorage.setItem('payments', JSON.stringify(filteredPayments));
                loadPaymentLedger(currentStudentId);
                alert('Payment deleted successfully!');
            }
        }

        window.onclick = function(event) {
            const studentModal = document.getElementById('studentModal');
            const paymentLedgerModal = document.getElementById('paymentLedgerModal');
            const paymentModal = document.getElementById('paymentModal');
            
            if (event.target === studentModal) {
                studentModal.style.display = 'none';
            }
            if (event.target === paymentLedgerModal) {
                paymentLedgerModal.style.display = 'none';
            }
            if (event.target === paymentModal) {
                paymentModal.style.display = 'none';
            }
        }
    </script>
</body>
</html>
